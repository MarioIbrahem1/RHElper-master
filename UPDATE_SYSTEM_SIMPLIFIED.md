# تبسيط نظام التحديث

تم تبسيط نظام التحديث في التطبيق لحل مشكلة عدم عمل التحديثات بشكل صحيح. هذا الملف يشرح التغييرات التي تم إجراؤها والخطوات اللازمة للتأكد من أن نظام التحديث يعمل بشكل صحيح.

## التغييرات التي تم إجراؤها

1. **تبسيط آلية التنزيل**:
   - تم إزالة طلب الأذونات المعقدة التي كانت تسبب مشاكل
   - تم استخدام المتصفح مباشرة لتنزيل التحديثات بدلاً من محاولة تنزيلها داخل التطبيق
   - تم إضافة محاولات متعددة لفتح المتصفح بطرق مختلفة

2. **تحسين واجهة المستخدم**:
   - تم تحسين مربع حوار التنزيل ليكون أكثر وضوحًا
   - تمت إضافة زر إلغاء للسماح للمستخدم بإلغاء التنزيل
   - تم تحسين عرض حالة التنزيل

3. **إزالة الكود غير المستخدم**:
   - تمت إزالة الدوال غير المستخدمة
   - تمت إزالة الاستيرادات غير الضرورية

## كيفية عمل نظام التحديث الجديد

1. عند بدء التطبيق، يتم التحقق من وجود تحديثات جديدة.
2. إذا كان هناك تحديث جديد، يتم عرض مربع حوار للمستخدم.
3. عند النقر على "تحديث الآن"، يتم عرض مربع حوار التنزيل.
4. يتم فتح المتصفح تلقائيًا لتنزيل ملف APK.
5. إذا لم يتم فتح المتصفح تلقائيًا، يمكن للمستخدم النقر على زر "تنزيل التحديث".
6. بعد تنزيل الملف، يجب على المستخدم تثبيته يدويًا.

## كيفية رفع تحديث جديد

### 1. إنشاء ملف JSON للتحديث

يجب إنشاء ملف JSON يحتوي على معلومات التحديث بالتنسيق التالي:

```json
{
  "version": "1.0.1",
  "versionCode": 2,
  "downloadUrl": "https://firebasestorage.googleapis.com/v0/b/road-helper-fed8f.firebasestorage.app/o/Road_Helper_v1.0.1-release.apk?alt=media&token=YOUR_TOKEN",
  "releaseNotes": "تحسينات في الأداء وإصلاح بعض الأخطاء",
  "forceUpdate": false
}
```

حيث:
- `version`: رقم الإصدار الجديد (مثل "1.0.1")
- `versionCode`: رقم الإصدار الرقمي (يجب أن يكون أكبر من الإصدار الحالي)
- `downloadUrl`: رابط تنزيل ملف APK من Firebase Storage
- `releaseNotes`: ملاحظات الإصدار التي ستظهر للمستخدم
- `forceUpdate`: إذا كان `true`، سيتم إجبار المستخدم على التحديث

### 2. رفع ملف APK إلى Firebase Storage

1. قم بإنشاء ملف APK للإصدار الجديد من التطبيق
2. قم بتسجيل الدخول إلى [Firebase Console](https://console.firebase.google.com/)
3. انتقل إلى مشروعك > Storage
4. قم برفع ملف APK إلى المجلد المناسب
5. بعد الرفع، انقر بزر الماوس الأيمن على الملف واختر "Get download URL"
6. انسخ الرابط واستخدمه في ملف JSON للتحديث

### 3. رفع ملف JSON للتحديث إلى Firebase Storage

1. قم برفع ملف JSON للتحديث إلى Firebase Storage باسم `version.json`
2. إذا كنت تستبدل ملفًا موجودًا، فستحتفظ بنفس الرابط
3. إذا كنت ترفع ملفًا جديدًا، فستحتاج إلى تحديث الرابط في التطبيق

## حل المشكلات الشائعة

### المتصفح لا يفتح تلقائيًا

إذا لم يتم فتح المتصفح تلقائيًا، يمكن للمستخدم النقر على زر "تنزيل التحديث" في مربع الحوار.

### المستخدم لا يستطيع تثبيت التطبيق

تأكد من أن المستخدم قد قام بتفعيل "تثبيت التطبيقات من مصادر غير معروفة" في إعدادات الأمان.

### رابط التنزيل لا يعمل

تأكد من أن رابط التنزيل في ملف JSON صحيح ويمكن الوصول إليه.

## ملاحظات هامة

- تأكد من زيادة `versionCode` في ملف JSON عند كل تحديث جديد.
- تأكد من تحديث `version` في ملف `pubspec.yaml` للتطبيق عند إصدار نسخة جديدة.
- يتم التحقق من التحديثات بشكل دوري كل 24 ساعة.
- تأكد من أن رابط تنزيل APK صحيح ويمكن الوصول إليه.
